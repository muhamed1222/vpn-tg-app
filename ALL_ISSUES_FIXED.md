# ‚úÖ –í–°–ï –ü–†–û–ë–õ–ï–ú–´ –ò–°–ü–†–ê–í–õ–ï–ù–´

**–î–∞—Ç–∞:** 2026-01-17  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

---

## üî¥ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. ‚úÖ `getActiveContest()` –≤–æ–∑–≤—Ä–∞—â–∞–ª `null`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- SQL —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ ISO —Å—Ç—Ä–æ–∫ —Ä–∞–±–æ—Ç–∞–ª–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ `null`, –±–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è JavaScript —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞—Ç (—Ç–æ—á–Ω–æ–µ)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω–∫—É—Ä—Å–æ–≤

**–ö–æ–¥:**
```typescript
// –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –¥–∞—Ç–∞–º –≤ JavaScript
for (const contest of contests) {
    const startTime = new Date(contest.starts_at).getTime();
    const endTime = new Date(contest.ends_at).getTime();
    
    console.log(`[ContestService] Checking contest ${contest.id}...`);
    
    if (nowTimestamp >= startTime && nowTimestamp <= endTime) {
        console.log(`[ContestService] ‚úÖ Active contest found: ${contest.id}`);
        return contest;
    }
}
```

---

### 2. ‚úÖ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤ `getActiveContest()`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–ª–∞—Å—å –¥–≤–∞–∂–¥—ã (–¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤)
- –õ–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –í—ã–∑–æ–≤ –æ–¥–∏–Ω —Ä–∞–∑, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –∫–æ–¥

**–ö–æ–¥:**
```typescript
// –í—ã–∑—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑
const activeContest = ContestService.getActiveContest();
if (activeContest) {
    // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –±–∏–ª–µ—Ç—ã
    ...
    // –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ activeContest)
    ContestService.awardSelfPurchaseTicket(activeContest.id, ...);
}
```

---

### 3. ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –ª–æ–≥–æ–≤ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `getActiveContest()`
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `getActiveContest()`
- ‚úÖ –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω–∫—É—Ä—Å–æ–≤
- ‚úÖ –õ–æ–≥–∏—Ä—É—é—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–µ –∏ –Ω–µ—É—Å–ø–µ—à–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤

**–õ–æ–≥–∏:**
```
[ContestService] Checking contest 550e8400...: start=2026-01-17T00:00:00Z, end=2026-02-20T23:59:59Z
[ContestService] ‚úÖ Active contest found: 550e8400... (üéâ –†–æ–∑—ã–≥—Ä—ã—à Outlivion)
[OrderProcessing] Attempting to award self-purchase ticket...
[ContestService] ‚úÖ Awarded 1 tickets to user 782245481 for order ord_...
```

---

### 4. ‚úÖ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `awardSelfPurchaseTicket`, –Ω–æ —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `awardSelfTickets`
- –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã vs —Å–µ–∫—É–Ω–¥—ã)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è-–æ–±–µ—Ä—Ç–∫–∞ `awardSelfPurchaseTicket`
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ –≤ —Å–µ–∫—É–Ω–¥—ã
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç –∑–∞–∫–∞–∑–∞

**–ö–æ–¥:**
```typescript
awardSelfPurchaseTicket: (
    contestId: string,
    userId: number,
    orderId: string,
    planId: string,
    orderCreatedAt: number // Unix timestamp –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
): boolean => {
    return ContestService.awardSelfTickets(
        contestId, 
        userId, 
        orderId, 
        planId, 
        Math.floor(orderCreatedAt / 1000) // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Å–µ–∫—É–Ω–¥—ã
    );
}
```

---

### 5. ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç –∑–∞–∫–∞–∑–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–æ–≤–µ—Ä—è–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
- –ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∞—Å—å –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∏ –Ω–∞—á–∞–ª–æ, –∏ –æ–∫–æ–Ω—á–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä—Å–∞
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫

**–ö–æ–¥:**
```typescript
if (orderCreatedAt < contestStartsAt) {
    console.log(`‚ö†Ô∏è Order created before contest start`);
    return false;
}

if (orderCreatedAt > contestEndsAt) {
    console.log(`‚ö†Ô∏è Order created after contest end`);
    return false;
}

console.log(`‚úÖ Order created during contest period`);
```

---

### 6. ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ API —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–∞—Ö

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –æ—à–∏–±–∫–∏ —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–ö–æ–¥:**
```typescript
logError('Payments history request', null, {
    backendUrl,
    hasInitData: !!initData,
});

if (!backendResponse.ok) {
    logError('Payments history API error', new Error(errorMessage), {
        status: backendResponse.status,
        error: errorMessage,
    });
}
```

---

## üìã –ò–ó–ú–ï–ù–ï–ù–ù–´–ï –§–ê–ô–õ–´

### 1. `/root/vpn_bot/src/services/contestService.ts`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `getActiveContest()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JavaScript —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞—Ç
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `awardSelfPurchaseTicket()` –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞–º–∏
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç –∑–∞–∫–∞–∑–∞ (–Ω–∞—á–∞–ª–æ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä—Å–∞)

### 2. `/root/vpn_bot/src/services/orderProcessingService.ts`
- ‚úÖ –£–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤ `getActiveContest()`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –±–∏–ª–µ—Ç–æ–≤

### 3. `/vpnwebsite/app/api/payments/history/route.ts`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

### –î–ª—è –±—É–¥—É—â–∏—Ö –ø–æ–∫—É–ø–æ–∫:
- ‚úÖ `getActiveContest()` —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ë–∏–ª–µ—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç –∑–∞–∫–∞–∑–∞

### –î–ª—è –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞:
- ‚ö†Ô∏è –ó–∞–∫–∞–∑ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞
- ‚úÖ –ë–∏–ª–µ—Ç —Å–æ–∑–¥–∞–Ω –≤—Ä—É—á–Ω—É—é (–¥–ª—è —Ç–µ—Å—Ç–∞)
- ‚úÖ –£–¥–∞–ª–µ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è

---

## üîç –õ–û–ì–ò –î–õ–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω–∫—É—Ä—Å–∞:
```bash
journalctl -u vpn-bot -f | grep -E "ContestService.*Active contest|Checking contest"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤:
```bash
journalctl -u vpn-bot -f | grep -E "OrderProcessing.*award|ContestService.*Awarded"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫:
```bash
journalctl -u vpn-bot -f | grep -E "ContestService.*Error|OrderProcessing.*Failed"
```

---

## ‚úÖ –°–¢–ê–¢–£–°

**–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:**
- ‚úÖ `getActiveContest()` —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ë–∏–ª–µ—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –∫–æ–¥

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄ
