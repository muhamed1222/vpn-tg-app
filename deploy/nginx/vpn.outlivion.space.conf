server {
    listen 80;
    server_name vpn.outlivion.space;
    # Перенаправление всех HTTP запросов на HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name vpn.outlivion.space;

    # Пути к сертификатам
    ssl_certificate /var/lib/marzban/certs/fullchain.pem;
    ssl_certificate_key /var/lib/marzban/certs/key.pem;

    # Настройки SSL
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
    ssl_prefer_server_ciphers off;

    # Логи (опционально)
    access_log /var/log/nginx/marzban.access.log;
    error_log /var/log/nginx/marzban.error.log;

    # Telegram Webhook (ВАЖНО: должен быть ПЕРЕД location /)
    location /webhook/telegram {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Важно: не парсим body, оставляем raw для webhook
        proxy_set_header Content-Type application/json;
    }

    # Payment Webhooks
    location = /webhook/payment/cryptocloud {
        return 404;
    }

    location = /webhook/payment/cryptobot {
        return 404;
    }

    # Yukassa allowed (removed 404 block)

    location /webhook/payment {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API endpoints для Mini App (ВАЖНО: должен быть ПЕРЕД location /api)
    # Используем /bot-api чтобы не конфликтовать с Marzban /api
    location /bot-api {
        proxy_pass http://127.0.0.1:3000/api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Проксирование подписок через наш бот (порт 3000) для добавления заголовков
    location /sub {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Health check (ВАЖНО: должен быть ПЕРЕД location /)
    location /health {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
    }

    # Marzban API (ВАЖНО: должен быть ПЕРЕД location /)
    # Все запросы к /api/* идут на Marzban (кроме /bot-api)
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Статические файлы для подтверждения Heleket
    location = /heleket_7c51e4ac.html {
        alias /var/lib/marzban/heleket_7c51e4ac.html;
    }

    # Проксирование всего остального на Marzban (порт 8000)
    location / {
        # Если это корень сайта, подменяем путь на /dashboard/
        rewrite ^/$ /dashboard/ break;

        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
