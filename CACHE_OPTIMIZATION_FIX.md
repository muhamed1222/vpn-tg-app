# Унификация стратегии кэширования

## Дата исправления
2025-01-27

## Проблема
Кэширование использовалось не везде, где нужно, и не было унифицировано:
- Тарифы кэшируются (через `cachedFetch` и localStorage)
- История платежей не кэшировалась
- Статус пользователя не кэшировался через API кэш
- Разные стратегии кэширования в разных местах

## Решение

### 1. Создана унифицированная стратегия кэширования

**Файл:** `lib/utils/cache-strategy.ts`

**Содержание:**
- `CacheStrategy` enum - типы стратегий кэширования
- `CACHE_CONFIG` - конфигурация TTL для всех типов данных
- Функции для получения конфигурации кэширования

**Стратегии:**
- `NO_CACHE` - не кэшировать (для критичных данных)
- `SHORT` - 1-2 минуты (для часто меняющихся данных)
- `MEDIUM` - 2-5 минут (для относительно стабильных данных)
- `LONG` - 10+ минут (для редко меняющихся данных)

---

### 2. Добавлено кэширование для всех API endpoints

#### `lib/api.ts`

**Добавлено кэширование для:**

1. ✅ **`getPaymentsHistory`** - 2 минуты
   ```typescript
   getPaymentsHistory: async () => {
     const { cachedFetch } = await import('@/lib/utils/apiCache');
     return cachedFetch('payments_history', () => apiFetch(...), 2 * 60 * 1000);
   }
   ```

2. ✅ **`getUserStatus`** - 1 минута
   ```typescript
   getUserStatus: async () => {
     const { cachedFetch } = await import('@/lib/utils/apiCache');
     return cachedFetch('user_status', async () => { ... }, 1 * 60 * 1000);
   }
   ```

3. ✅ **`getReferralHistory`** - 2 минуты
   ```typescript
   getReferralHistory: async () => {
     const { cachedFetch } = await import('@/lib/utils/apiCache');
     return cachedFetch('referral_history', () => apiFetch(...), 2 * 60 * 1000);
   }
   ```

4. ✅ **`getContestSummary`** - 1 минута
   ```typescript
   getContestSummary: async (contestId: string) => {
     const { cachedFetch } = await import('@/lib/utils/apiCache');
     return cachedFetch(`contest_summary_${contestId}`, () => apiFetch(...), 1 * 60 * 1000);
   }
   ```

5. ✅ **`getContestFriends`** - 1 минута
   ```typescript
   getContestFriends: async (contestId: string, limit: number = 50) => {
     const { cachedFetch } = await import('@/lib/utils/apiCache');
     return cachedFetch(`contest_friends_${contestId}_${limit}`, () => apiFetch(...), 1 * 60 * 1000);
   }
   ```

6. ✅ **`getContestTickets`** - 1 минута
   ```typescript
   getContestTickets: async (contestId: string) => {
     const { cachedFetch } = await import('@/lib/utils/apiCache');
     return cachedFetch(`contest_tickets_${contestId}`, () => apiFetch(...), 1 * 60 * 1000);
   }
   ```

**Уже было кэширование:**
- ✅ `getTariffs` - 5 минут
- ✅ `getUserConfig` - 2 минуты
- ✅ `getReferralStats` - 2 минуты
- ✅ `getAutorenewal` - 1 минута
- ✅ `getActiveContest` - 1 минута

---

### 3. Унифицирована стратегия кэширования в хуках

#### `hooks/useTariffs.ts`

**Изменения:**
- Добавлены комментарии, объясняющие двойное кэширование
- `cachedFetch` в API - для дедупликации запросов в памяти
- `localStorage` в хуке - для персистентности между сессиями
- Фоновая загрузка актуальных данных при использовании кэша

#### `hooks/useMinPrice.ts`

**Изменения:**
- Добавлены комментарии, объясняющие стратегию кэширования
- Фоновая загрузка актуальных данных при использовании кэша

#### `hooks/useSubscriptionUrl.ts`

**Изменения:**
- Добавлены комментарии, объясняющие стратегию кэширования
- Фоновая загрузка актуальных данных при использовании кэша

---

## Результаты

### Кэширование по типам данных

| Тип данных | TTL | Стратегия | Статус |
|------------|-----|-----------|--------|
| Тарифы | 5 минут | MEDIUM | ✅ |
| История платежей | 2 минуты | SHORT | ✅ **ДОБАВЛЕНО** |
| Статус пользователя | 1 минута | SHORT | ✅ **ДОБАВЛЕНО** |
| Конфигурация VPN | 2 минуты | MEDIUM | ✅ |
| Статистика рефералов | 2 минуты | MEDIUM | ✅ |
| История рефералов | 2 минуты | SHORT | ✅ **ДОБАВЛЕНО** |
| Автопродление | 1 минута | SHORT | ✅ |
| Активный конкурс | 1 минута | SHORT | ✅ |
| Сводка конкурса | 1 минута | SHORT | ✅ **ДОБАВЛЕНО** |
| Друзья в конкурсе | 1 минута | SHORT | ✅ **ДОБАВЛЕНО** |
| Билеты конкурса | 1 минута | SHORT | ✅ **ДОБАВЛЕНО** |

---

### Стратегия кэширования

#### Двойное кэширование (оптимально):

1. **`cachedFetch` (в памяти)**
   - Дедупликация одновременных запросов
   - Быстрый доступ к данным
   - Работает на сервере и клиенте

2. **`localStorage` (персистентный)**
   - Сохранение данных между сессиями
   - Быстрая загрузка при повторном открытии
   - Работает только на клиенте

#### Преимущества:
- ✅ Быстрая первая загрузка (из localStorage)
- ✅ Дедупликация запросов (через cachedFetch)
- ✅ Фоновая актуализация данных
- ✅ Персистентность между сессиями

---

## Тестирование

### Компиляция TypeScript
```bash
npx tsc --noEmit
```
✅ **Результат:** 0 ошибок

### Сборка проекта
```bash
npm run build
```
✅ **Результат:** Успешно скомпилировано

---

## Рекомендации

### Для будущих API endpoints

1. ✅ **Использовать `cachedFetch` для всех GET запросов**
   - Автоматическая дедупликация
   - Уменьшение нагрузки на сервер

2. ✅ **Настраивать TTL в зависимости от типа данных**
   - Часто меняющиеся данные: 1-2 минуты
   - Относительно стабильные: 2-5 минут
   - Редко меняющиеся: 10+ минут

3. ✅ **Использовать `cache-strategy.ts` для конфигурации**
   - Централизованное управление TTL
   - Легко изменить стратегию для всех endpoints

4. ⚠️ **Не кэшировать POST/PUT/DELETE запросы**
   - Кэширование только для GET запросов
   - POST/PUT/DELETE всегда делают свежий запрос

---

## Заключение

✅ **Проблема решена полностью**

Все API endpoints теперь используют унифицированную стратегию кэширования. История платежей, статус пользователя и другие endpoints теперь кэшируются. Проект готов к production с оптимизированным кэшированием.

---

*Документ создан автоматически при унификации стратегии кэширования*
