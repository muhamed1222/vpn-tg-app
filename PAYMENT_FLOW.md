# –ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

## üìã –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

### –®–∞–≥ 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å"

1. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞** (`handlePayClick`)
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `api.createOrder(planId, selectedMethodId)`
   - –ü–æ–ª—É—á–∞–µ–º `orderId` –∏ `paymentUrl`
   - –°–æ—Ö—Ä–∞–Ω—è–µ–º `orderId` –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: `setOrderId(response.orderId)`

2. **–û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ–∂–∏–¥–∞–Ω–∏—è**
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è `WaitingPaymentModal` —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
   - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã"

3. **–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É**
   - –ß–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è `paymentUrl` (–ÆK–∞—Å—Å–∞)
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã

### –®–∞–≥ 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ÆK–∞—Å—Å—ã**
   - –í–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
   - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—É
   - –ÆK–∞—Å—Å–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂

2. **Telegram –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ**
   - Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ `successful_payment` –±–æ—Ç—É
   - –ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ ‚Üí –∑–∞–∫–∞–∑ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Å—Ç–∞—Ç—É—Å `PAID` ‚Üí –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞

### –®–∞–≥ 3: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π polling –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è** (`startPolling`)
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
   - –ú–∞–∫—Å–∏–º—É–º 30 –ø–æ–ø—ã—Ç–æ–∫ (1 –º–∏–Ω—É—Ç–∞)

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã** (–∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã)

   **–í–∞—Ä–∏–∞–Ω—Ç A: –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–± (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π)**
   ```typescript
   if (orderId) {
     const paymentResult = await api.checkPaymentSuccess(orderId);
     
     if (paymentResult.status === 'completed') {
       // ‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!
       setIsPaid(true);
       stopPolling();
       // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
       await login(true);
       // –ß–µ—Ä–µ–∑ 2.5 —Å–µ–∫—É–Ω–¥—ã –∑–∞–∫—Ä—ã–≤–∞–µ–º –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
     }
   }
   ```

   **–í–∞—Ä–∏–∞–Ω—Ç B: Fallback (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±)**
   ```typescript
   const result = await login(true);
   const sub = useSubscriptionStore.getState().subscription;
   
   if (sub?.status === 'active') {
     // ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞!
     setIsPaid(true);
     stopPolling();
   }
   ```

### –®–∞–≥ 4: –£—Å–ø–µ—à–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è

1. **–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è**
   - `WaitingPaymentModal` –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ `isPaid={true}`
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è:
     - ‚úÖ –ó–µ–ª–µ–Ω–∞—è –∏–∫–æ–Ω–∫–∞ —É—Å–ø–µ—Ö–∞
     - "–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!"
     - "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ VPN"
     - –ö–Ω–æ–ø–∫–∞ "–û—Ç–ª–∏—á–Ω–æ"

2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥**
   - –ß–µ—Ä–µ–∑ 2.5 —Å–µ–∫—É–Ω–¥—ã:
     - –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
     - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (`router.push('/')`)

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `login(true)` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–æ—Ä –ø–æ–¥–ø–∏—Å–∫–∏ (`useSubscriptionStore`)
   - –ù–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞

## üîÑ –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –±—ç–∫–µ–Ω–¥–µ

### Endpoint `/api/payment/success`

–ö–æ–≥–¥–∞ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—ã–∑—ã–≤–∞–µ—Ç `api.checkPaymentSuccess(orderId)`:

1. **–ó–∞–∫–∞–∑ —É–∂–µ COMPLETED**
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{ status: 'completed', vless_key, expires_at }`
   - –ü–æ–¥–ø–∏—Å–∫–∞ —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞

2. **–ó–∞–∫–∞–∑ PAID (–æ–ø–ª–∞—á–µ–Ω, –Ω–æ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω)**
   - –ü—Ä–æ–±—É–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å: `OrderProcessingService.activateOrder(order)`
   - –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `completed`
   - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `pending`

3. **–ó–∞–∫–∞–∑ INVOICED (–±–æ—Ç –Ω–µ –ø–æ–ª—É—á–∏–ª —Å–æ–±—ã—Ç–∏–µ)**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç –∑–∞–∫–∞–∑–∞
   - –ï—Å–ª–∏ –∑–∞–∫–∞–∑ —Å—Ç–∞—Ä—à–µ 2 –º–∏–Ω—É—Ç:
     - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `PAID`
     - –ü—Ä–æ–±—É–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
     - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

## ‚è±Ô∏è –¢–∞–π–º–ª–∞–π–Ω

```
0:00 - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å"
0:01 - –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–∫–∞–∑, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
0:02 - –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ÆK–∞—Å—Å—É
0:30 - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç (–ø—Ä–∏–º–µ—Ä–Ω–æ)
0:32 - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
0:32 - –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è polling (–∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã)
0:34 - –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ api.checkPaymentSuccess()
0:36 - –í—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞...
0:38 - –¢—Ä–µ—Ç—å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Üí —Å—Ç–∞—Ç—É—Å 'completed' ‚úÖ
0:38 - –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å–ø–µ—Ö
0:41 - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
```

## üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫

1. **–ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω**
   - Fallback –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ `login()`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –≤ —Å—Ç–æ—Ä–µ

2. **–ï—Å–ª–∏ polling –Ω–µ –Ω–∞—à–µ–ª –æ–ø–ª–∞—Ç—É**
   - –ú–∞–∫—Å–∏–º—É–º 30 –ø–æ–ø—ã—Ç–æ–∫ (1 –º–∏–Ω—É—Ç–∞)
   - –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ polling –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—Ä—É—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å

3. **Recovery –º–µ—Ö–∞–Ω–∏–∑–º –Ω–∞ –±—ç–∫–µ–Ω–¥–µ**
   - –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –ø–æ–ª—É—á–∏–ª —Å–æ–±—ã—Ç–∏–µ –æ—Ç Telegram
   - Recovery –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –∑–∞–∫–∞–∑—ã `INVOICED`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∏—Ö

## üì± UI —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –°–æ—Å—Ç–æ—è–Ω–∏–µ 1: –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã
- –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ (–∫—Ä—É—Ç—è—â–∏–π—Å—è —Å–ø–∏–Ω–Ω–µ—Ä)
- –¢–µ–∫—Å—Ç: "–û–ø–ª–∞—Ç–∏—Ç–µ —Å—á–µ—Ç –≤ —Å–µ—Ä–≤–∏—Å–µ –ÆK–∞—Å—Å–∞"
- –ö–Ω–æ–ø–∫–∞: "–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã"

### –°–æ—Å—Ç–æ—è–Ω–∏–µ 2: –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞
- ‚úÖ –ó–µ–ª–µ–Ω–∞—è –∏–∫–æ–Ω–∫–∞ —É—Å–ø–µ—Ö–∞
- –¢–µ–∫—Å—Ç: "–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!"
- –ö–Ω–æ–ø–∫–∞: "–û—Ç–ª–∏—á–Ω–æ"
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 2.5 —Å–µ–∫—É–Ω–¥—ã
