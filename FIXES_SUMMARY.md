# üìã –°–í–û–î–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

**–î–∞—Ç–∞:** 2026-01-17  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

---

## üî¥ –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è: `getActiveContest()` –≤–æ–∑–≤—Ä–∞—â–∞–ª `null`
- **–ü—Ä–∏—á–∏–Ω–∞:** SQL —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ ISO —Å—Ç—Ä–æ–∫ —Ä–∞–±–æ—Ç–∞–ª–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å

### 2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤
- **–ü—Ä–∏—á–∏–Ω–∞:** `getActiveContest()` –≤—ã–∑—ã–≤–∞–ª—Å—è –¥–≤–∞–∂–¥—ã
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –õ–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- **–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ç –ª–æ–≥–æ–≤ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å, –ø–æ—á–µ–º—É –±–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è

### 4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏
- **–ü—Ä–∏—á–∏–Ω–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `awardSelfPurchaseTicket`, –Ω–æ —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `awardSelfTickets`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã vs —Å–µ–∫—É–Ω–¥—ã)

### 5. –ù–µ–ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç
- **–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–≤–µ—Ä—è–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∞—Å—å –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è

### 6. –ü—Ä–æ–±–ª–µ–º—ã —Å API —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- **–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

---

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `getActiveContest()`
```typescript
// ‚úÖ –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
WHERE starts_at <= ? AND ends_at >= ?  // SQL —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫

// ‚úÖ –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
const contests = database.prepare(`SELECT * FROM contests WHERE is_active = 1`).all();
for (const contest of contests) {
    const startTime = new Date(contest.starts_at).getTime();
    const endTime = new Date(contest.ends_at).getTime();
    if (nowTimestamp >= startTime && nowTimestamp <= endTime) {
        return contest; // ‚úÖ –¢–æ—á–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
    }
}
```

### 2. –£–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤
```typescript
// ‚úÖ –í—ã–∑—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑
const activeContest = ContestService.getActiveContest();
if (activeContest) {
    // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –±–∏–ª–µ—Ç—ã
    ...
    // –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ activeContest)
    ContestService.awardSelfPurchaseTicket(activeContest.id, ...);
}
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```typescript
console.log(`[ContestService] Checking contest ${contest.id}...`);
console.log(`[ContestService] ‚úÖ Active contest found: ${contest.id}`);
console.log(`[OrderProcessing] Attempting to award self-purchase ticket...`);
console.log(`[ContestService] ‚úÖ Awarded ${tickets} tickets...`);
```

### 4. –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `awardSelfPurchaseTicket()`
```typescript
awardSelfPurchaseTicket: (
    contestId: string,
    userId: number,
    orderId: string,
    planId: string,
    orderCreatedAt: number // Unix timestamp –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
): boolean => {
    return ContestService.awardSelfTickets(
        contestId, userId, orderId, planId,
        Math.floor(orderCreatedAt / 1000) // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Å–µ–∫—É–Ω–¥—ã
    );
}
```

### 5. –£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç –∑–∞–∫–∞–∑–∞
```typescript
if (orderCreatedAt < contestStartsAt) {
    console.log(`‚ö†Ô∏è Order created before contest start`);
    return false;
}

if (orderCreatedAt > contestEndsAt) {
    console.log(`‚ö†Ô∏è Order created after contest end`);
    return false;
}

console.log(`‚úÖ Order created during contest period`);
```

### 6. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ API
```typescript
logError('Payments history request', null, {
    backendUrl,
    hasInitData: !!initData,
});

if (!backendResponse.ok) {
    logError('Payments history API error', new Error(errorMessage), {
        status: backendResponse.status,
        error: errorMessage,
    });
}
```

---

## üìÅ –ò–ó–ú–ï–ù–ï–ù–ù–´–ï –§–ê–ô–õ–´

1. ‚úÖ `/root/vpn_bot/src/services/contestService.ts`
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ `getActiveContest()`
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –°–æ–∑–¥–∞–Ω–∞ `awardSelfPurchaseTicket()`
   - –£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç

2. ‚úÖ `/root/vpn_bot/src/services/orderProcessingService.ts`
   - –£–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

3. ‚úÖ `/vpnwebsite/app/api/payments/history/route.ts`
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

### –î–ª—è –±—É–¥—É—â–∏—Ö –ø–æ–∫—É–ø–æ–∫:
- ‚úÖ `getActiveContest()` —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ë–∏–ª–µ—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç –∑–∞–∫–∞–∑–∞

### –î–ª—è –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞:
- ‚ö†Ô∏è –ó–∞–∫–∞–∑ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞
- ‚úÖ –ë–∏–ª–µ—Ç —Å–æ–∑–¥–∞–Ω –≤—Ä—É—á–Ω—É—é (–¥–ª—è —Ç–µ—Å—Ç–∞)
- ‚úÖ –£–¥–∞–ª–µ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è

---

## üîç –ö–ê–ö –ü–†–û–í–ï–†–ò–¢–¨

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –∫–æ–Ω–∫—É—Ä—Å–∞:
```bash
journalctl -u vpn-bot -f | grep -E "ContestService.*Active contest|Checking contest"
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤:
```bash
journalctl -u vpn-bot -f | grep -E "OrderProcessing.*award|ContestService.*Awarded"
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫:
```bash
journalctl -u vpn-bot -f | grep -E "ContestService.*Error|OrderProcessing.*Failed"
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:
```sql
SELECT * FROM ticket_ledger 
WHERE order_id = 'ord_...' 
AND reason = 'SELF_PURCHASE';
```

---

## ‚úÖ –°–¢–ê–¢–£–°

**–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!**

- ‚úÖ `getActiveContest()` —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ë–∏–ª–µ—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –∫–æ–¥

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄ

---

## üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. ‚úÖ –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –∑–∞–¥–µ–ø–ª–æ–µ–Ω
2. ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å –Ω–æ–≤–æ–π –ø–æ–∫—É–ø–∫–æ–π
3. ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–∫—É–ø–∫–µ
4. ‚ö†Ô∏è –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±–∏–ª–µ—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

**–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä!** ‚úÖ
