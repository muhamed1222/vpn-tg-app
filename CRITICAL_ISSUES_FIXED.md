# üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ò–°–ü–†–ê–í–õ–ï–ù–´

**–î–∞—Ç–∞:** 2026-01-17  
**–ü—Ä–æ–±–ª–µ–º—ã:** –ë–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è, —Å–∞–π—Ç –Ω–µ –≤–∏–¥–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê #1: –ë–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è

### –ü—Ä–∏—á–∏–Ω–∞:
**`getActiveContest()` –≤–æ–∑–≤—Ä–∞—â–∞–ª `null` –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–∞—Ç –≤ SQL:**

```typescript
// ‚ùå –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
WHERE starts_at <= ? AND ends_at >= ?  // SQL —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ ISO —Å—Ç—Ä–æ–∫
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- SQLite —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ –ª–µ–∫—Å–∏–∫–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏
- `'2026-01-17T00:00:00Z' <= '2026-01-17 20:05:50'` –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å `false`
- –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ `null`, –±–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å

### –†–µ—à–µ–Ω–∏–µ:
```typescript
// ‚úÖ –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
const contests = database.prepare(`SELECT * FROM contests WHERE is_active = 1`).all();
// –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –¥–∞—Ç–∞–º –≤ JavaScript
for (const contest of contests) {
    const startTime = new Date(contest.starts_at).getTime();
    const endTime = new Date(contest.ends_at).getTime();
    if (nowTimestamp >= startTime && nowTimestamp <= endTime) {
        return contest; // ‚úÖ –¢–æ—á–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
    }
}
```

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê #2: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤

### –ü—Ä–∏—á–∏–Ω–∞:
**`getActiveContest()` –≤—ã–∑—ã–≤–∞–ª—Å—è –î–í–ê —Ä–∞–∑–∞:**
1. –î–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤ (—Å—Ç—Ä–æ–∫–∞ 206)
2. –î–ª—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤ (—Å—Ç—Ä–æ–∫–∞ 239)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –õ–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ –≤–µ—Ä–Ω—É–ª `null`, –≤—Ç–æ—Ä–æ–π —Ç–æ–∂–µ –≤–µ—Ä–Ω–µ—Ç `null`

### –†–µ—à–µ–Ω–∏–µ:
```typescript
// ‚úÖ –í—ã–∑—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
const activeContest = ContestService.getActiveContest();
if (activeContest) {
    // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –±–∏–ª–µ—Ç—ã
    ...
    // –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ activeContest)
    ContestService.awardSelfPurchaseTicket(activeContest.id, ...);
}
```

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê #3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏—á–∏–Ω–∞:
- –ù–µ—Ç –ª–æ–≥–æ–≤ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `getActiveContest()`
- –ù–µ—Ç –ª–æ–≥–æ–≤ –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –±–∏–ª–µ—Ç–æ–≤
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É

### –†–µ—à–µ–Ω–∏–µ:
```typescript
// ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
console.log(`[OrderProcessing] Active contest found: ${activeContest.id}`);
console.log(`[OrderProcessing] Attempting to award self-purchase ticket...`);
if (ticketAwarded) {
    console.log(`[OrderProcessing] ‚úÖ Successfully awarded...`);
} else {
    console.log(`[OrderProcessing] ‚ö†Ô∏è Failed to award...`);
}
```

---

## üìã –ü–†–û–ë–õ–ï–ú–ê –° –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø–ú–ò –ù–ê –°–ê–ô–¢–ï

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–§—Ä–æ–Ω—Ç–µ–Ω–¥:** `/app/(auth)/profile/page.tsx`
   - –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ `TransactionsModal`
   - –í—ã–∑—ã–≤–∞–µ—Ç `api.getPaymentsHistory()`

2. **API Route:** `/app/api/payments/history/route.ts`
   - –ü—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥: `${BACKEND_API_URL}/v1/payments/history`
   - –¢—Ä–µ–±—É–µ—Ç Telegram `initData` –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

3. **Backend API:** `/v1/payments/history`
   - –î–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. ‚ùå **–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** - `initData` –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è
2. ‚ùå **Backend API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** - endpoint –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
3. ‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL** - `BACKEND_API_URL` —É–∫–∞–∑–∞–Ω –Ω–µ–≤–µ—Ä–Ω–æ
4. ‚ùå **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–∞–Ω–Ω—ã–µ –∫–µ—à–∏—Ä—É—é—Ç—Å—è –∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

---

## ‚úÖ –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û

### 1. –§—É–Ω–∫—Ü–∏—è `getActiveContest()`:
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç JavaScript —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞—Ç (—Ç–æ—á–Ω–æ–µ)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞:
- ‚úÖ –£–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤ `getActiveContest()`
- ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ª–æ–≥–∏ –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –±–∏–ª–µ—Ç–æ–≤
- ‚úÖ –ú–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
- ‚úÖ –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –æ—à–∏–±–∫–∏
- ‚úÖ –ú–æ–∂–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

### –î–ª—è –±—É–¥—É—â–∏—Ö –ø–æ–∫—É–ø–æ–∫:
- ‚úÖ `getActiveContest()` —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ë–∏–ª–µ—Ç—ã –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–º–æ–∂–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

### –î–ª—è –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞:
- ‚ö†Ô∏è –ó–∞–∫–∞–∑ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞
- ‚ö†Ô∏è –ë–∏–ª–µ—Ç —Å–æ–∑–¥–∞–Ω –≤—Ä—É—á–Ω—É—é (–¥–ª—è —Ç–µ—Å—Ç–∞)
- ‚úÖ –£–¥–∞–ª–µ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê

### –ó–∞–∫–∞–∑—ã –±–µ–∑ –±–∏–ª–µ—Ç–æ–≤ (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):
- `ord_974a1676-4359-464b-896d-9b7066ac10f4` (20:02:53) - ‚ùå –ù–ï–¢ –ë–ò–õ–ï–¢–ê
- `ord_5903a2e6-c254-4568-9ad3-e0a2ee3b9f98` (19:55:32) - ‚ùå –ù–ï–¢ –ë–ò–õ–ï–¢–ê

**–ü—Ä–∏—á–∏–Ω–∞:** `getActiveContest()` –≤–æ–∑–≤—Ä–∞—â–∞–ª `null` –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–∞—Ç

---

## üîç –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –¢–†–ê–ù–ó–ê–ö–¶–ò–ô

### –ü—Ä–æ–≤–µ—Ä–∫–∞ API:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å endpoint
curl 'https://vpn.outlivion.space/v1/payments/history' \
  -H 'Authorization: <telegram_init_data>'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:
```bash
journalctl -u vpn-bot -f | grep -i "payments\|history\|transactions"
```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –ë–∏–ª–µ—Ç—ã –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –ø–æ–∫—É–ø–æ–∫.
