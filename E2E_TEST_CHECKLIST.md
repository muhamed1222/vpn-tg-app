# End-to-End –¢–µ—Å—Ç: –ü–æ–ª–Ω—ã–π —Ñ–ª–æ—É –æ–ø–ª–∞—Ç—ã

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

1. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–∞–±–∏–Ω–µ—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –Ω–∞ `https://my.outlivion.space`
2. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ API —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ `https://api.outlivion.space`
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –õ–ö YooKassa

## –®–∞–≥ 1: –û—Ç–∫—Ä—ã—Ç—å –∫–∞–±–∏–Ω–µ—Ç

- –û—Ç–∫—Ä–æ–π—Ç–µ `https://my.outlivion.space` –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã `/pay` (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ö—É–ø–∏—Ç—å")

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–ª–∞—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å –≤—ã–±–æ—Ä–æ–º –ø–ª–∞–Ω–æ–≤

---

## –®–∞–≥ 2: –ù–∞–∂–∞—Ç—å "–ö—É–ø–∏—Ç—å"

1. –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, "month" –∏–ª–∏ "test-10")
2. –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã "–ÆKassa" (–µ—Å–ª–∏ –Ω–µ –≤ Telegram)
3. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å —Å–µ–π—á–∞—Å"

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:**

- –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞..." (loading state)
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å: `POST https://api.outlivion.space/v1/orders/create`
- –í localStorage —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `lastOrderId` (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ DevTools ‚Üí Application ‚Üí Local Storage)
- –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `paymentUrl` –æ—Ç YooKassa

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ DevTools (Console):**

```javascript
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π orderId
localStorage.getItem('lastOrderId')
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** 
- –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã YooKassa (URL –≤–∏–¥–∞ `https://yoomoney.ru/checkout/...`)
- –í localStorage –µ—Å—Ç—å `lastOrderId`

---

## –®–∞–≥ 3: –û–ø–ª–∞—Ç–∞ –≤ YooKassa

1. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ YooKassa –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π/—Ä–µ–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂
2. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã YooKassa –≤–µ—Ä–Ω–µ—Ç –≤–∞—Å –Ω–∞ `YOOKASSA_RETURN_URL`

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `https://my.outlivion.space/#/pay/return` (–∏–ª–∏ `/pay/return` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ—É—Ç–∏–Ω–≥–∞)

---

## –®–∞–≥ 4: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (/pay/return)

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:**

1. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
2. –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è "–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É..." —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
3. –ö–∞–∂–¥—ã–µ 2.5 —Å–µ–∫—É–Ω–¥—ã –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å: `GET https://api.outlivion.space/v1/orders/:orderId`
4. –ö–æ–≥–¥–∞ —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `paid`:
   - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è "–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!"
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è VPN –∫–ª—é—á
   - –ï—Å—Ç—å –∫–Ω–æ–ø–∫–∞ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
   - `lastOrderId` —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ localStorage

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ DevTools (Network):**

- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã –∑–∞–ø—Ä–æ—Å—ã `GET /v1/orders/:orderId` –∫–∞–∂–¥—ã–µ 2-3 —Å–µ–∫—É–Ω–¥—ã
- –ö–æ–≥–¥–∞ webhook –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è, —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏—Ç—Å—è —Å `pending` –Ω–∞ `paid`

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ DevTools (Console):**

```javascript
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π orderId
localStorage.getItem('lastOrderId')

// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å null
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–ª—é—á
- –ö–Ω–æ–ø–∫–∞ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ö–ª—é—á –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞

---

## –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞ VPS:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
ssh root@72.56.93.135
journalctl -u outlivion-api -n 50 --no-pager | grep -E "(Order marked|webhook|payment)"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–∫–∞–∑ –≤ –ë–î
cd /opt/outlivion-api
node -e "const db = require('better-sqlite3')('data/db.sqlite'); const order = db.prepare('SELECT * FROM orders ORDER BY created_at DESC LIMIT 1').get(); console.log(JSON.stringify(order, null, 2));"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í –ª–æ–≥–∞—Ö –µ—Å—Ç—å –∑–∞–ø–∏—Å—å "Order marked as paid with key"
- –í –ë–î –∑–∞–∫–∞–∑ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `paid` –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø–æ–ª–µ–º `key`

---

## –ß–µ–∫-–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

- [ ] –ö–∞–±–∏–Ω–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ `https://my.outlivion.space`
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–ª–∞—Ç—ã `/pay` –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- [ ] –ö–Ω–æ–ø–∫–∞ "–ö—É–ø–∏—Ç—å" —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ API
- [ ] `lastOrderId` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage
- [ ] –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ YooKassa –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
- [ ] –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
- [ ] –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ `/pay/return` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É..."
- [ ] Polling –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 2-3 —Å–µ–∫—É–Ω–¥—ã
- [ ] –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `paid`
- [ ] VPN –∫–ª—é—á –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- [ ] –ö–Ω–æ–ø–∫–∞ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] `lastOrderId` —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ localStorage –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞

---

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –û—Ç–∫—Ä–æ–π—Ç–µ DevTools ‚Üí Console
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏ JavaScript
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Network tab –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ `/v1/orders/create`

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API –¥–æ—Å—Ç—É–ø–µ–Ω: `curl https://api.outlivion.space/health`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞: orderId –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```javascript
// –í Console –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "–ö—É–ø–∏—Ç—å"
localStorage.getItem('lastOrderId')
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `payment.order_id` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∏–∑ API
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ –≤ `usePayment.ts` —Å—Ç—Ä–æ–∫–∏ 80-82

### –ü—Ä–æ–±–ª–µ–º–∞: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç orderId

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- DevTools ‚Üí Application ‚Üí Local Storage ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `lastOrderId`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `/pay/return` –∏–ª–∏ `/#/pay/return`

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è HashRouter (–µ—Å–ª–∏ URL —Å `#`)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –º–∞—Ä—à—Ä—É—Ç `/pay/return` –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ `App.tsx`

### –ü—Ä–æ–±–ª–µ–º–∞: –°—Ç–∞—Ç—É—Å –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `paid`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- DevTools ‚Üí Network ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –∫ `/v1/orders/:orderId`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –õ–ö YooKassa
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è (–ª–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∑–∞–∫–∞–∑ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–ª—é—á –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–≤–µ—Ç API: `GET /v1/orders/:orderId` –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å `{ status: "paid", key: "..." }`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "Order marked as paid with key"

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook –æ–±—Ä–∞–±–æ—Ç–∞–ª—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Marzban (–∏–ª–∏ –∑–∞–≥–ª—É—à–∫–∞) —Å–æ–∑–¥–∞–µ—Ç –∫–ª—é—á
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î: –ø–æ–ª–µ `key` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–æ

---

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ API –ª–æ–∫–∞–ª—å–Ω–æ:

```bash
# –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
curl -s -X POST https://api.outlivion.space/v1/orders/create \
  -H "Content-Type: application/json" \
  -d '{"planId":"test-10","userRef":"e2e-test"}' | jq .

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å (–∑–∞–º–µ–Ω–∏—Ç–µ ORDER_ID)
ORDER_ID="–≤–∞—à-order-id"
curl -s https://api.outlivion.space/v1/orders/$ORDER_ID | jq .
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ VPS:

```bash
# –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞
ssh root@72.56.93.135
journalctl -u outlivion-api -f

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞
cd /opt/outlivion-api
node -e "const db = require('better-sqlite3')('data/db.sqlite'); console.log(JSON.stringify(db.prepare('SELECT order_id, status, key FROM orders ORDER BY created_at DESC LIMIT 1').get(), null, 2));"
```

---

## –£—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç

–ï—Å–ª–∏ –≤—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ:

‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–µ—Ç—Å—è  
‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ YooKassa —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç  
‚úÖ –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ `/pay/return` —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ Polling –Ω–∞—Ö–æ–¥–∏—Ç –∑–∞–∫–∞–∑ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `paid`  
‚úÖ –ö–ª—é—á –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è  
‚úÖ –ö–Ω–æ–ø–∫–∞ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" —Ä–∞–±–æ—Ç–∞–µ—Ç  

**–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç! üéâ**


