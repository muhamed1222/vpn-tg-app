# Настройка входа через Telegram бота

## Обзор

Сайт использует авторизацию через Telegram WebApp. При открытии сайта через бота Telegram автоматически передает данные пользователя (`initData`), которые используются для авторизации на API бота.

## Как это работает

1. **Пользователь открывает WebApp в Telegram**
   - Telegram загружает сайт внутри приложения
   - Telegram WebApp SDK автоматически инициализируется
   - Telegram передает `initData` с данными пользователя

2. **Авторизация на сайте**
   - Сайт получает `initData` из Telegram WebApp
   - `initData` отправляется в заголовке `Authorization` на API бота
   - Бот проверяет и валидирует `initData`
   - Бот возвращает данные пользователя

3. **Работа приложения**
   - Пользователь автоматически авторизован
   - Данные пользователя и подписки загружаются из API
   - Все дальнейшие запросы используют `initData` для авторизации

## Пошаговая настройка

### Шаг 1. Настройка переменных окружения сайта

Создайте файл `.env.local` в корне проекта (`/Users/kelemetovmuhamed/Documents/vpnwebsite/.env.local`):

**Для локальной разработки:**
```env
# URL API бота (локальный сервер)
VITE_API_URL=http://localhost:3000
```

**Для продакшена:**
```env
# URL API бота (продакшн сервер)
VITE_API_URL=https://vpn.outlivion.space
```

> **Важно:** После изменения `.env.local` нужно перезапустить сервер разработки.

### Шаг 2. Настройка бота

#### 2.1. Переменные окружения бота

В файле `.env` бота (`/path/to/vpn_bot/.env`) добавьте:

```env
# Токен бота
TELEGRAM_BOT_TOKEN=ваш_токен_бота

# Режим polling для локальной разработки
TELEGRAM_USE_POLLING=1

# Порт API бота
PORT=3000

# CORS - разрешенные домены для запросов
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000,https://web.telegram.org,https://ваш-домен.com
```

> **Важно для продакшна:** В `ALLOWED_ORIGINS` должен быть ваш реальный домен сайта.

#### 2.2. Настройка CORS в коде бота

Убедитесь, что в `server.ts` бота настроен CORS:

```typescript
import cors from 'cors';

const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || [];
app.use(cors({
  origin: (origin, callback) => {
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true
}));
```

#### 2.3. Обработка авторизации через initData

В боте должен быть middleware для проверки `initData`:

```typescript
// Пример middleware для проверки initData
app.use('/api/*', async (req, res, next) => {
  const initData = req.headers.authorization;
  
  if (!initData) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  
  // Валидация initData (используйте библиотеку для проверки подписи Telegram)
  const isValid = await validateTelegramWebAppData(initData, process.env.BOT_TOKEN);
  
  if (!isValid) {
    return res.status(401).json({ error: 'Invalid initData' });
  }
  
  // Извлечение данных пользователя из initData
  const user = parseInitData(initData);
  req.user = user; // Сохраняем данные пользователя в запросе
  
  next();
});
```

### Шаг 3. Настройка WebApp URL в Telegram

#### 3.1. Через @BotFather

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/mybots`
3. Выберите вашего бота
4. Выберите `Bot Settings` → `Menu Button` или `Web App`
5. Укажите URL вашего сайта:
   - Для разработки: `http://localhost:5173` (не работает напрямую, нужен туннель)
   - Для продакшна: `https://ваш-домен.com`

#### 3.2. Через Bot API (программно)

```typescript
// Установка WebApp URL через Bot API
await bot.telegram.setChatMenuButton({
  menu_button: {
    type: 'web_app',
    text: 'Открыть',
    web_app: {
      url: 'https://ваш-домен.com'
    }
  }
});
```

> **Важно:**
> - WebApp URL должен быть доступен по **HTTPS** (кроме localhost).
> - Для локальной разработки используйте туннель (ngrok, Cloudflare Tunnel и т.д.).

### Шаг 4. Настройка туннеля для локальной разработки (опционально)

Если нужно тестировать WebApp локально:

#### Вариант 1. Ngrok

```bash
# Установите ngrok
brew install ngrok  # для macOS

# Запустите туннель
ngrok http 5173

# Используйте полученный HTTPS URL в BotFather
# Например: https://abc123.ngrok.io
```

#### Вариант 2. Cloudflare Tunnel

```bash
# Установите cloudflared
brew install cloudflared

# Запустите туннель
cloudflared tunnel --url http://localhost:5173

# Используйте полученный URL в BotFather
```

### Шаг 5. Проверка работы

1. **Запустите бота:**
   ```bash
   cd /path/to/vpn_bot
   npm run dev
   ```

2. **Запустите сайт:**
   ```bash
   cd /Users/kelemetovmuhamed/Documents/vpnwebsite
   npm run dev
   ```

3. **Откройте бота в Telegram:**
   - Найдите вашего бота в Telegram
   - Отправьте команду `/start`
   - Нажмите на кнопку WebApp или используйте меню бота

4. **Проверьте авторизацию:**
   - Откроется сайт внутри Telegram
   - Нажмите "Продолжить с Telegram"
   - Должна произойти автоматическая авторизация
   - Вы должны попасть на страницу аккаунта

## Отладка

### Проверка в консоли браузера

Откройте консоль разработчика (F12) и проверьте:

1. **Telegram WebApp инициализирован:**
   ```javascript
   // Должно вернуть объект WebApp
   window.Telegram?.WebApp
   ```

2. **initData доступен:**
   ```javascript
   // Должно вернуть строку с данными
   window.Telegram?.WebApp?.initData
   ```

3. **API запросы:**
   - Проверьте Network вкладку в DevTools
   - Запросы к `/api/me` должны иметь заголовок `Authorization` с `initData`
   - Ответ должен содержать данные пользователя

### Типичные ошибки

#### Ошибка: "Telegram WebApp не инициализирован"

**Причина:** Сайт открыт не через Telegram, а в обычном браузере.

**Решение:** Откройте сайт через кнопку WebApp в Telegram боте.

#### Ошибка: CORS error

**Причина:** Домен сайта не добавлен в `ALLOWED_ORIGINS` бота.

**Решение:** 
1. Добавьте домен в `ALLOWED_ORIGINS` в `.env` бота
2. Перезапустите бота

#### Ошибка: 401 Unauthorized

**Причина:** `initData` невалидный или не передается в заголовке.

**Решение:**
1. Проверьте, что `initData` доступен в `window.Telegram.WebApp.initData`
2. Проверьте логику валидации `initData` в боте
3. Убедитесь, что используется правильный токен бота для валидации

#### Ошибка: API недоступен

**Причина:** Неправильный `VITE_API_URL` или бот не запущен.

**Решение:**
1. Проверьте `.env.local` файл
2. Убедитесь, что бот запущен и доступен по указанному URL
3. Проверьте доступность API: откройте `http://localhost:3000/api/me` в браузере (должна быть ошибка авторизации, но не 404)

## Структура initData

`initData` от Telegram содержит информацию о пользователе в формате URL-параметров:

```
user=%7B%22id%22%3A123456789%2C%22first_name%22%3A%22John%22%7D&auth_date=1234567890&hash=abc123...
```

После парсинга можно получить:
- `user` - данные пользователя (id, first_name, username и т.д.)
- `auth_date` - время авторизации
- `hash` - подпись для проверки валидности

> **Важно:** Всегда валидируйте `initData` на стороне сервера, используя токен бота.

## Безопасность

1. **Валидация initData:**
   - Всегда проверяйте подпись `initData` на сервере
   - Используйте токен бота для проверки
   - Не доверяйте данным из `initDataUnsafe` без проверки

2. **HTTPS:**
   - В продакшне используйте только HTTPS
   - Telegram требует HTTPS для WebApp

3. **CORS:**
   - Ограничьте `ALLOWED_ORIGINS` только необходимыми доменами
   - Не используйте `*` в продакшне

4. **Токены:**
   - Не храните токен бота в клиентском коде
   - Используйте переменные окружения

## Чек-лист настройки

Перед запуском убедитесь:

- [ ] Создан файл `.env.local` с правильным `VITE_API_URL`
- [ ] Бот настроен с правильными переменными окружения
- [ ] CORS настроен в боте с правильными доменами
- [ ] WebApp URL установлен в BotFather
- [ ] Бот запущен и доступен по указанному URL
- [ ] Сайт запущен и доступен
- [ ] Сайт доступен по HTTPS (для продакшна)
- [ ] initData валидируется на стороне сервера

## Дополнительные ресурсы

- [Telegram WebApp документация](https://core.telegram.org/bots/webapps)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [Vite Environment Variables](https://vitejs.dev/guide/env-and-mode.html)
