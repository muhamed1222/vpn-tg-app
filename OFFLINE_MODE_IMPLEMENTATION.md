# Реализация офлайн-режима с Service Worker

## Дата реализации
2025-01-27

## Проблема
Нет обработки офлайн-режима. Приложение не работает без интернета.

## Решение

### 1. Создан Service Worker

**Файл:** `public/sw.js`

**Функциональность:**
- ✅ Кэширование статических ресурсов
- ✅ Кэширование динамических данных
- ✅ Стратегии кэширования:
  - **Cache First** - для статических ресурсов (JS, CSS, изображения, шрифты)
  - **Network First** - для API запросов (с fallback на кэш)
  - **Network First с Offline Fallback** - для страниц (с fallback на офлайн-страницу)

**Кэши:**
- `outlivion-vpn-static-v1` - статические ресурсы
- `outlivion-vpn-dynamic-v1` - динамические данные

---

### 2. Созданы утилиты для работы с Service Worker

**Файл:** `lib/utils/service-worker.ts`

**Функции:**
- ✅ `isServiceWorkerSupported()` - проверка поддержки
- ✅ `registerServiceWorker()` - регистрация Service Worker
- ✅ `unregisterServiceWorker()` - отмена регистрации
- ✅ `checkForServiceWorkerUpdate()` - проверка обновлений
- ✅ `activateServiceWorker()` - принудительная активация
- ✅ `getServiceWorkerInfo()` - получение информации
- ✅ `cacheUrls()` - кэширование указанных URL

---

### 3. Создан провайдер Service Worker

**Файл:** `components/ServiceWorkerProvider.tsx`

**Функциональность:**
- ✅ Автоматическая регистрация Service Worker
- ✅ Регистрация только в production (или при `NEXT_PUBLIC_ENABLE_SW=true`)
- ✅ Обработка обновлений Service Worker

**Интеграция:**
- Добавлен в `app/layout.tsx` как обертка для всего приложения

---

### 4. Создана офлайн-страница

**Файл:** `app/offline/page.tsx`

**Функциональность:**
- ✅ Отображение сообщения об отсутствии интернета
- ✅ Автоматическое перенаправление при восстановлении связи
- ✅ Кнопка "Попробовать снова"
- ✅ Индикация восстановления подключения

**Дизайн:**
- Темная тема (соответствует общему дизайну)
- Иконка Wi-Fi (отключен)
- Понятное сообщение на русском языке

---

### 5. Создан индикатор офлайн-режима

**Файл:** `components/OfflineIndicator.tsx`

**Функциональность:**
- ✅ Отображение баннера при переходе в офлайн
- ✅ Отображение сообщения о восстановлении подключения
- ✅ Автоматическое скрытие через 2 секунды после восстановления
- ✅ Использование существующей системы `subscribeToOnlineStatus`

**Интеграция:**
- Добавлен в `app/layout.tsx` для глобального отображения

---

### 6. Интеграция с Next.js

**Изменения в `app/layout.tsx`:**
- ✅ Добавлен `ServiceWorkerProvider`
- ✅ Добавлен `OfflineIndicator`
- ✅ Правильный порядок провайдеров

**Изменения в `next.config.ts`:**
- ✅ CSP уже содержит `worker-src 'self' blob:` для Service Worker

---

## Стратегии кэширования

### 1. Статические ресурсы (Cache First)
- JS файлы (`/_next/static/`)
- CSS файлы
- Изображения (`.png`, `.jpg`, `.svg`, `.webp`, `.avif`)
- Шрифты (`.woff`, `.woff2`)
- Иконки (`.ico`)

**Логика:**
1. Проверяем кэш
2. Если есть - возвращаем из кэша
3. Если нет - загружаем из сети и кэшируем

---

### 2. API запросы (Network First)
- Запросы к `/api/*`
- Запросы к `api.outlivion.space`
- Запросы к `vpn.outlivion.space`

**Логика:**
1. Пытаемся загрузить из сети
2. Если успешно - кэшируем и возвращаем
3. Если ошибка - проверяем кэш
4. Если есть в кэше - возвращаем из кэша
5. Если нет - возвращаем ошибку 503 с JSON сообщением

---

### 3. Страницы (Network First с Offline Fallback)
- Главная страница (`/`)
- Другие страницы приложения

**Логика:**
1. Пытаемся загрузить из сети
2. Если успешно - кэшируем и возвращаем
3. Если ошибка - проверяем кэш
4. Если есть в кэше - возвращаем из кэша
5. Если нет - возвращаем офлайн-страницу (`/offline`)
6. Если нет офлайн-страницы - возвращаем простую HTML страницу

---

## Использование

### Автоматическая регистрация

Service Worker регистрируется автоматически при загрузке приложения (только в production).

### Ручная регистрация (для разработки)

Установите переменную окружения:
```bash
NEXT_PUBLIC_ENABLE_SW=true
```

### Проверка статуса

```typescript
import { getServiceWorkerInfo } from '@/lib/utils/service-worker';

const info = await getServiceWorkerInfo();
if (info) {
  console.log('Update available:', info.updateAvailable);
}
```

### Кэширование URL

```typescript
import { cacheUrls } from '@/lib/utils/service-worker';

await cacheUrls([
  '/api/tariffs',
  '/api/user/status',
]);
```

---

## Тестирование

### 1. Проверка регистрации

1. Откройте DevTools → Application → Service Workers
2. Убедитесь, что Service Worker зарегистрирован
3. Проверьте статус (activated)

### 2. Проверка кэширования

1. Откройте DevTools → Application → Cache Storage
2. Убедитесь, что созданы кэши:
   - `outlivion-vpn-static-v1`
   - `outlivion-vpn-dynamic-v1`

### 3. Проверка офлайн-режима

1. Откройте DevTools → Network → Offline
2. Перезагрузите страницу
3. Убедитесь, что:
   - Статические ресурсы загружаются из кэша
   - Отображается офлайн-страница или индикатор
   - API запросы возвращают кэшированные данные или ошибку

### 4. Проверка индикатора

1. Отключите интернет
2. Убедитесь, что появляется желтый баннер "Нет подключения к интернету"
3. Включите интернет
4. Убедитесь, что появляется зеленый баннер "Подключение восстановлено"
5. Баннер должен скрыться через 2 секунды

---

## Рекомендации

### Для production

1. ✅ Service Worker уже настроен для автоматической регистрации в production
2. ✅ Кэширование работает автоматически
3. ✅ Офлайн-страница доступна по `/offline`

### Для разработки

1. Установите `NEXT_PUBLIC_ENABLE_SW=true` для тестирования Service Worker
2. Используйте DevTools для отладки
3. Проверяйте кэши в Application → Cache Storage

### Дополнительные улучшения (опционально)

1. **Background Sync** - синхронизация данных при восстановлении связи
2. **Push Notifications** - уведомления через Service Worker
3. **Periodic Background Sync** - периодическая синхронизация
4. **IndexedDB** - хранение больших объемов данных для офлайн-режима

---

## Заключение

✅ **Проблема решена полностью**

Реализован полноценный офлайн-режим с Service Worker:
- ✅ Кэширование статических ресурсов
- ✅ Кэширование динамических данных
- ✅ Офлайн-страница
- ✅ Индикатор офлайн-режима
- ✅ Автоматическая регистрация
- ✅ Интеграция с Next.js

Приложение теперь работает без интернета, используя кэшированные данные.

---

*Документ создан автоматически при реализации офлайн-режима*
